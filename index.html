<!DOCTYPE html>
<title>ADMU Graduates Data Visualization</title>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="d3-src/d3-slider.css">
<link rel="stylesheet" type="text/css" href="src/style.css">


<body>
<div id ="newheader">
<h1>ADMU Graduates</h1>
A representation of post-graduation data from ADMU alumni from 2010-2014.
<BR /><BR />
</div>
  <div id="nav">
      <input name="2010" 
             type="button" 
             value="2010" 
             onclick="refreshGraph(2010);" />

      <input name="2011" 
             type="button" 
             value="2011" 
             onclick="refreshGraph(2011);" />

      <input name="2012" 
             type="button" 
             value="2012" 
             onclick="refreshGraph(2012);" />    

      <input name="2013" 
             type="button" 
             value="2013" 
             onclick="refreshGraph(2013);" />

      <input name="2014" 
             type="button" 
             value="2014" 
             onclick="refreshGraph(2014);" />    
  </div>

<script src="d3-src/d3.min.js"></script>
<script src="d3-src/d3.tip.js"></script>

<script>
/* ==================================================================
    VARIABLE DECLARATIONS
===================================================================== */ 
var legend_width = 150;
var absoluteView = false;

var margin = {top: 40, right: 0, bottom: 250, left: 50},
  width = 1150 - margin.left - margin.right,
  height = 600 - margin.top - margin.bottom;

var x = d3.scale.ordinal()
  .rangeRoundBands([0, width], .1);

var yAbsolute = d3.scale.linear() // for absolute scale
  .rangeRound([height, 0]);

var yRelative = d3.scale.linear() // for absolute scale
    .rangeRound([height, 0]);

var color = d3.scale.ordinal()
  .range(["#ffc65d", "#fc913a", "#7bc8a4", "#96cea4", "#f16745", "#ff6f69", "#ff8f7a"]);

var xAxis = d3.svg.axis()
  .scale(x)
  .orient("bottom");

var yAxisRelative = d3.svg.axis()
  .scale(yRelative)
  .orient("left")
  .tickFormat(d3.format(".1%"));

var yAxisAbsolute = d3.svg.axis()
  .scale(yAbsolute)
  .orient("left")
  .tickFormat(d3.format(".2s"));

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right + legend_width)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

function createGraph(year) {
  var fileName = "data/" + year + ".csv";
  /* ==================================================================
      CSV DECLARATION
  ===================================================================== */ 
  d3.csv(fileName, function(error, data) {
    color.domain(d3.keys(data[0]).filter(function(key) { return key !== "course" && key !== "respondents"}));
    data.forEach(function(d) {
      var mycourse = d.course;
      var y0 = 0;
      d.info = color.domain().map(function(name) { return {mycourse:mycourse, name: name, y0: y0, y1: y0 += +d[name]}; })
      d.total = d.info[d.info.length - 1].y1;// the last row  
      d.pct = [];
    
      for (var i=0;i <d.info.length;i ++ ){
        var y_coordinate = +d.info[i].y1/d.total;
        var y_height1 = (d.info[i].y1)/d.total; 
        var y_height0 = (d.info[i].y0)/d.total; 
        var y_pct = y_height1 - y_height0;
        d.pct.push({
          y_coordinate: y_coordinate,
          y_height1: y_height1,
          y_height0: y_height0,
          name: d.info[i].name,
          mycourse: d.course,
          y_pct: y_pct
        });
      }
    });
    x.domain(data.map(function(d) { return d.course; }));
    yAbsolute.domain([0, d3.max(data, function(d) { return d.total; })]); // Absolute View Domain 
    yRelative.domain([0,1]) // Relative View domain 
   
    svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")  
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)" );

  /* ==================================================================
      CSV DECLARATION: RELATIVE VIEW
  ===================================================================== */ 
    var courseRelative = svg.selectAll(".relative")
      .data(data)
      .enter().append("g")
        .attr("class", "relative")
        .attr("transform", function(d) { return "translate(" + "0 "+ ",0)"; });
      
    courseRelative.selectAll("rect")
      .data(function(d) {
        return d.pct;     
      })
      .enter().append("rect")
      .attr("width", x.rangeBand())
      .attr("y", function(d) {
        return yRelative(d.y_coordinate); 
      })
      .attr("x",function(d) {return x(d.mycourse)})
      .attr("height", function(d) { 
        return yRelative(d.y_height0) - yRelative(d.y_height1); //distance 
      })
      .attr("fill", function(d){return color(d.name)})
      .attr("stroke","pink")
      .attr("stroke-width",0.2)
      .attr("id",function(d) {return d.mycourse})
      .attr("class","relative")
      .attr("id",function(d) {return d.mycourse})
      .style("pointer-events","all")
      .attr("opacity",absoluteView?0:1);
       
    courseRelative.selectAll("rect")
      .on("mouseover", function(d){
        if(!absoluteView){
          var xPos = parseFloat(d3.select(this).attr("x"));
          var yPos = parseFloat(d3.select(this).attr("y"));
          var height = parseFloat(d3.select(this).attr("height"))
                  
          d3.select(this)
            .attr("opacity", 0.7);             
          
          svg.append("text")
            .attr("x",xPos)
            .attr("y",yPos +height/2)
            .attr("class","tooltip")
            .text(Math.floor(d.y_pct.toFixed(2)*100) + "% of " + d.mycourse );               
        }
      })
      .on("mouseout",function(){
        if(!absoluteView){
          svg.select(".tooltip").remove();
          d3.select(this)
            .attr("opacity", 1);
        }                  
      })    
  /* ==================================================================
      CSV DECLARATION: ABSOLUTE VIEW
  ===================================================================== */     
    var courseAbsolute= svg.selectAll(".absolute")
      .data(data)
      .enter().append("g")
        .attr("class", "absolute")
        .attr("transform", function(d) { return "translate(" + "0" + ",0)"; });
      
    courseAbsolute.selectAll("rect")
      .data(function(d) { return d.info})
      .enter().append("rect")
      .attr("width", x.rangeBand())
      .attr("y", function(d) { 
        return yAbsolute(d.y1); 
      })
      .attr("x",function(d) {
        return x(d.mycourse)
      })
      .attr("height", function(d) { 
        return yAbsolute(d.y0) - yAbsolute(d.y1); 
      })
      .attr("fill", function(d){
        return color(d.name)
      })
      .attr("id",function(d) {
        return d.mycourse
      })
      .attr("class","absolute")
      .style("pointer-events","all")
      .attr("opacity",absoluteView?1:0); // Initially invisible
            
  /* ==================================================================
      DEFINE 2 SCALES, ONE OF WHICH IS ALWAYS HIDDEN
  ===================================================================== */ 
    svg.append("g")
      .attr("class", "y axis absolute")
      .call(yAxisAbsolute)
      .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Number of Respondents");
      
    svg.append("g")
      .attr("class", "y axis relative")
      .call(yAxisRelative)
      .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Percentage of Respondents");
           
    svg.select(".y.axis.absolute").style("opacity",absoluteView?1:0);
    svg.select(".y.axis.relative").style("opacity",absoluteView?0:1);  
    
  /* ==================================================================
      LEGEND DECLARATION
  ===================================================================== */ 
    var legend = svg.selectAll(".legend")
      .data(color.domain().slice().reverse())
      .enter().append("g")
        .attr("class", "legend")
        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

    legend.append("rect")
      .attr("x", width - 18 + legend_width)
      .attr("width", 18)
        .attr("height", 18)
        .attr("fill", color);

    legend.append("text")
      .attr("x", width - 24 + legend_width)
      .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "end")
      .text(function(d) { return d; });

    var clickButton = svg.selectAll(".clickButton")
      .data([30,30])
      .enter().append("g")
      .attr("class","clickButton")
      .attr("transform","translate(-30," + 160 +")"); 
            
    clickButton.append("text")
      .attr("x", width + legend_width)
      .attr("y", 35)
      .attr("dy", ".35em")
        .style("text-anchor", "end")
      .text("Switch View")
      .style("text-decoration", "underline") 
      .style("font-size", "16px")
      .attr("fill","#444")
      .attr("id","clickChangeView");      

    clickButton.append("text")
      .attr("x", width + legend_width -12)
      .attr("y", 9)
      .attr("dy", ".35em")
        .style("text-anchor", "end")
      .text(year)
      .style("text-decoration", "bold") 
      .style("font-size", "30px")
      .attr("fill","#444");
      
    // Init
    if (!absoluteView)
      swapToRelative();
    else
      swapToAbsolute;

    // Switch view on click the clickButton 
    d3.selectAll("#"+ "clickChangeView")
    .on("click",function(){
      if (absoluteView) {
        swapToRelative();      
      } else {
        swapToAbsolute();        
      }
      absoluteView = !absoluteView 
    });

    
    function swapToAbsolute(){    
      courseRelative.selectAll("rect").transition().duration(1000).style("opacity",0); // Hide relative rectangles
      courseAbsolute.selectAll("rect").transition().duration(1000).style("opacity",1); // Show absolute rectangles  
      svg.select(".y.axis.relative").transition().duration(1000).style("opacity",0); // Hide relative axis
      svg.select(".y.axis.absolute").transition().duration(1000).style("opacity",1); // Show absolute axis
    }
    
    function swapToRelative(){
      courseAbsolute.selectAll("rect").transition().duration(1000).attr("fill",function(d) {return  color(d.name)})
      courseAbsolute.selectAll("rect").transition().duration(1000).style("opacity",0); // Hide absolute rectangles      
      courseRelative.selectAll("rect").transition().duration(1000).style("opacity",1); // Show relative rectangles  
      svg.select(".y.axis.relative").transition().duration(1000).style("opacity",1);  // Show relative axis   
      svg.select(".y.axis.absolute").transition().duration(1000).style("opacity",0);// Hide absolute axis         
    }
  }); // CSV Declaration

}

function refreshGraph (year) {
  var svg = d3.select("svg").select("g");
  svg.selectAll("*").remove();

  createGraph(year);
}

createGraph(2014); // Init to 2014
</script>



</body>